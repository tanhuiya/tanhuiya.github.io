---
layout: post
title:  "iOS 推送详解"
date:   2016-10-19 16:50:00 +0800
categories: iOS
---
# iOS 推送详解

iOS10 和 iOS9或者更低版本注册方式不同，iOS10 的推送更简单了，但是对于我们来说其实是要多适配一个版本而已.

注册代码如下:

	-(void)registerRemoteNotification:(id)delegate{    
	    if ([[[UIDevice currentDevice] systemVersion] floatValue] >= 10.0) {
	        //iOS 10 later
	        UNUserNotificationCenter *center = [UNUserNotificationCenter currentNotificationCenter];
	        //必须写代理，不然无法监听通知的接收与点击事件
	        center.delegate = delegate;
	        [center requestAuthorizationWithOptions:(UNAuthorizationOptionBadge | UNAuthorizationOptionSound | UNAuthorizationOptionAlert) completionHandler:^(BOOL granted, NSError * _Nullable error) {
	            if (!error && granted) {
	                //用户点击允许
	                NSLog(@"注册成功");
	            }else{
	                //用户点击不允许
	                NSLog(@"注册失败");
	            }
	        }];
	        
	        // 可以通过 getNotificationSettingsWithCompletionHandler 获取权限设置
	        //获取用户的推送设置信息
	        [center getNotificationSettingsWithCompletionHandler:^(UNNotificationSettings * _Nonnull settings) {
	            NSLog(@"========%@",settings);
	        }];
	    }else if ([[[UIDevice currentDevice] systemVersion] floatValue] >= 8.0) {
	        
	        UIUserNotificationType types = (UIUserNotificationTypeAlert |
	                                        UIUserNotificationTypeSound |
	                                        UIUserNotificationTypeBadge);
	        
	        UIUserNotificationSettings *settings;
	        settings = [UIUserNotificationSettings settingsForTypes:types categories:nil];
	        //[[UIApplication sharedApplication] registerForRemoteNotifications];
	        [[UIApplication sharedApplication] registerUserNotificationSettings:settings];
	        
	    }
	    UIRemoteNotificationType apn_type = (UIRemoteNotificationType)(UIRemoteNotificationTypeAlert |
	                                                                   UIRemoteNotificationTypeSound |
	                                                                   UIRemoteNotificationTypeBadge);
	    [[UIApplication sharedApplication] registerForRemoteNotificationTypes:apn_type];
	    [[UIApplication sharedApplication] registerForRemoteNotifications];
	}

iOS10 的注册回调方法和以前还是同一个方法

	- (void)application:(UIApplication *)application didRegisterForRemoteNotificationsWithDeviceToken:(NSData *)deviceToken {
	    [CiPush CiPushRegistDeviceToken:deviceToken];
	}
	
iOS8 iOS9 无论在前台还是后台，在后台时点击通知进入应用也会回调这个方法，
收到远程消息会调用如下方法，可以通过applicationState 参数获取当前应用的状态，

	- (void)application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo fetchCompletionHandler:(void (^)(UIBackgroundFetchResult result))completionHandler {
	    // 处理APNs代码，通过userInfo可以取到推送的信息（包括内容，角标，自定义参数等）。如果需要弹窗等其他操作，则需要自行编码。
	    //    NSLog(@"\n>>>[Receive RemoteNotification - Background Fetch]:%@\n\n",userInfo);
	
	    completionHandler(UIBackgroundFetchResultNewData);
	    
	    if ([[[UIDevice currentDevice] systemVersion] floatValue]<10.0&&application.applicationState != UIApplicationStateActive) {
	        [self notificationDidClicked:userInfo];
	    }
	}
	
iOS 7 收到远程消息回调
	
	// 按道理这是iOS7 的回调方法，目前已经废弃，但是在调试的时候发现iOS10 收到通知依然会回调这个方法，可能是iOS10 的bug	
	- (void)application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo {
	    [self notificationDidClicked:userInfo];
	
	}
	
iOS 10 新通知

iOS10 推出了一套新的推送机制，收到消息，以及打开消息通过 UNUserNotificationCenterDelegate 这个代理实现，当然要导入 #import <UserNotifications/UserNotifications.h>

以下是两个很重要的代理方法，但是由于上述说的，可能是iOS10 bug，有些时候这两个方法不调用，而是调用了iOS 7 的回调，为了保险起见，在两个方法里都添加对远程通知的处理。

iOS 注册代理方法，上面代码已经提及

	UNUserNotificationCenter *center = [UNUserNotificationCenter currentNotificationCenter];
	//必须写代理，不然无法监听通知的接收与点击事件
	center.delegate = delegate;
	[center requestAuthorizationWithOptions:(UNAuthorizationOptionBadge | UNAuthorizationOptionSound | UNAuthorizationOptionAlert) completionHandler:^(BOOL granted, NSError * _Nullable error) {
	    if (!error && granted) {
	        //用户点击允许
	        NSLog(@"注册成功");
	    }else{
	        //用户点击不允许
	        NSLog(@"注册失败");
	    }
	}];

收到远程通知时调用

	- (void)userNotificationCenter:(UNUserNotificationCenter *)center willPresentNotification:(UNNotification *)notification withCompletionHandler:(void (^)(UNNotificationPresentationOptions options))completionHandler{
	    //NSLog(@"%@",notification);
	    //收到推送的请求
	    UNNotificationRequest *request = notification.request;
	    //收到推送的内容
	    UNNotificationContent *content = request.content;
	    //收到用户的基本信息
	    NSDictionary *userInfo = content.userInfo;
	    //收到推送消息的角标
	    NSNumber *badge = content.badge;
	    //收到推送消息body
	    NSString *body = content.body;
	    //推送消息的声音
	    UNNotificationSound *sound = content.sound;
	    // 推送消息的副标题
	    NSString *subtitle = content.subtitle;
	    // 推送消息的标题
	    NSString *title = content.title;
	    
	    if([notification.request.trigger isKindOfClass:[UNPushNotificationTrigger class]]) {
	       // NSLog(@"iOS10 收到远程通知:%@",userInfo);
	    }else {
	        // 判断为本地通知
	        //NSLog(@"iOS10 收到本地通知:{\\\\nbody:%@，\\\\ntitle:%@,\\\\nsubtitle:%@,\\\\nbadge：%@，\\\\nsound：%@，\\\\nuserInfo：%@\\\\n}",body,title,subtitle,badge,sound,userInfo);
	    }
	    
	    // 需要执行这个方法，选择是否提醒用户，有Badge、Sound、Alert三种类型可以设置
	    completionHandler(UNNotificationPresentationOptionBadge|
	                      UNNotificationPresentationOptionSound|
	                      UNNotificationPresentationOptionAlert);
	}
	
点击通知进入应用时调用代理方法

	// The method will be called on the delegate when the user responded to the notification by opening the application, dismissing the notification or choosing a UNNotificationAction. The delegate must be set before the application returns from applicationDidFinishLaunching:.
	- (void)userNotificationCenter:(UNUserNotificationCenter *)center didReceiveNotificationResponse:(UNNotificationResponse *)response withCompletionHandler:(void(^)())completionHandler{
	    NSLog(@"%@",response);
	    //收到推送的请求
	    UNNotificationRequest *request = response.notification.request;
	    //收到推送的内容
	    UNNotificationContent *content = request.content;
	    //收到用户的基本信息
	    NSDictionary *userInfo = content.userInfo;
	    
	    //收到推送消息的角标
	    NSNumber *badge = content.badge;
	    //收到推送消息body
	    NSString *body = content.body;
	    //推送消息的声音
	    UNNotificationSound *sound = content.sound;
	    // 推送消息的副标题
	    NSString *subtitle = content.subtitle;
	    // 推送消息的标题
	    NSString *title = content.title;
	    if([response.notification.request.trigger isKindOfClass:[UNPushNotificationTrigger class]]) {
	        //NSLog(@"iOS10 收到远程通知:%@",userInfo);
	    }else {
	        // 判断为本地通知
	       // NSLog(@"iOS10 收到本地通知:{\\\\nbody:%@，\\\\ntitle:%@,\\\\nsubtitle:%@,\\\\nbadge：%@，\\\\nsound：%@，\\\\nuserInfo：%@\\\\n}",body,title,subtitle,badge,sound,userInfo);
	    }
	    completionHandler(); // 系统要求执行这个方法
	}
